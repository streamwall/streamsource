<div data-controller="collaborative-spreadsheet stream-table-preferences stream-view"
     data-collaborative-spreadsheet-current-user-id-value="<%= current_admin_user.id.to_s %>"
     data-collaborative-spreadsheet-current-user-name-value="<%= current_admin_user.display_name %>"
     data-collaborative-spreadsheet-current-user-color-value="<%= user_color(current_admin_user) %>"
     data-stream-table-preferences-hidden-columns-value="<%= @hidden_columns.to_json %>"
     data-stream-table-preferences-column-order-value="<%= @column_order.to_json %>"
     data-stream-table-preferences-preferences-url-value="<%= admin_stream_preferences_path %>"
     data-stream-view-storage-key-value="streamsViewMode"
     class="relative">
  
  <!-- Column Preferences + Active Users -->
  <div class="flex flex-wrap items-center justify-between gap-3 pb-3">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex flex-wrap items-center gap-2">
        <details class="relative">
          <summary class="cursor-pointer select-none px-3 py-1.5 text-sm bg-white border border-gray-200 rounded-md shadow-sm hover:bg-gray-50">
            Columns
          </summary>
          <div class="absolute left-0 mt-2 w-64 max-h-64 overflow-y-auto bg-white border border-gray-200 rounded-md shadow-lg z-20 p-3">
            <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Show columns</div>
            <div class="space-y-1" data-stream-table-preferences-target="columnList">
              <% stream_table_columns.each do |column| %>
                <div class="flex items-center gap-2 text-sm text-gray-700"
                     data-column="<%= column[:key] %>"
                     data-stream-table-preferences-target="columnItem">
                  <span class="text-gray-400 hover:text-gray-600 cursor-move"
                        data-stream-table-preferences-target="columnDrag"
                        title="Drag to reorder"
                        aria-hidden="true">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 6h.01M14 6h.01M10 12h.01M14 12h.01M10 18h.01M14 18h.01" />
                    </svg>
                  </span>
                  <label class="flex flex-1 items-center gap-2">
                    <%= check_box_tag "stream_columns[]",
                                      column[:key],
                                      !@hidden_columns.include?(column[:key]),
                                      class: "h-4 w-4 text-indigo-600 border-gray-300 rounded",
                                      data: { action: "stream-table-preferences#toggleColumn",
                                              stream_table_preferences_target: "columnToggle" } %>
                    <span><%= column[:label] %></span>
                  </label>
                </div>
              <% end %>
            </div>
          </div>
        </details>
        <span class="text-xs text-gray-500">Drag columns in the menu to reorder.</span>
      </div>

      <div class="flex items-center gap-2">
        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">View</span>
        <div class="inline-flex rounded-md shadow-sm bg-white border border-gray-200" role="group" aria-label="View mode">
          <button type="button"
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-1 rounded-l-md"
                  data-stream-view-target="toggle"
                  data-action="stream-view#select"
                  data-mode="table">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            <span class="hidden sm:inline">Table</span>
            <span class="sr-only sm:hidden">Table view</span>
          </button>
          <button type="button"
                  class="inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-50 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-1 rounded-r-md"
                  data-stream-view-target="toggle"
                  data-action="stream-view#select"
                  data-mode="card">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16" />
            </svg>
            <span class="hidden sm:inline">Cards</span>
            <span class="sr-only sm:hidden">Card view</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Active Users Presence -->
    <div class="flex items-center gap-2">
      <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Active Users</span>
      <span data-collaborative-spreadsheet-target="presenceCount"
            class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1.5 text-[11px] font-medium text-gray-600 bg-gray-100 rounded-full">
        0
      </span>
      <div data-collaborative-spreadsheet-target="presenceList"
           class="flex items-center gap-1">
        <!-- Users will be dynamically added here -->
      </div>
    </div>
  </div>
  
  <% sort_filter_params = params.except(:page, :sort, :direction)
                                   .permit(:status, :platform, :kind, :orientation, :user_id, :search, :is_pinned, :is_archived)
                                   .to_h %>
  <% sort_options = stream_table_columns.select { |column| column[:sortable] }
                                       .map { |column| [column[:label], column[:key]] } %>

  <!-- Card Sort Controls -->
  <div class="streams-card-sort flex flex-wrap items-center gap-2 pb-4">
    <div class="text-xs font-semibold uppercase tracking-wider text-gray-500">Sort</div>
    <%= form_with url: admin_streams_path,
                  method: :get,
                  data: { controller: "search", search_target: "form", turbo_frame: "streams_list", turbo_action: "advance" },
                  class: "flex flex-1 flex-wrap items-center gap-2" do |form| %>
      <% sort_filter_params.each do |key, value| %>
        <%= form.hidden_field key, value: value %>
      <% end %>
      <%= form.select :sort,
                      options_for_select(sort_options, @sort_column),
                      { include_blank: "Sort by" },
                      class: "flex-1 min-w-[160px] rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      data: { action: "change->search#submit" } %>
      <%= form.select :direction,
                      options_for_select([["Ascending", "asc"], ["Descending", "desc"]], @sort_direction),
                      {},
                      class: "min-w-[140px] rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm",
                      data: { action: "change->search#submit" } %>
    <% end %>
  </div>

  <!-- Spreadsheet Table -->
  <div class="streams-container overflow-visible md:overflow-x-auto md:bg-white md:rounded-lg md:shadow"
       data-stream-table-preferences-target="scrollContainer">
    <table class="streams-table block md:table min-w-full divide-y-0 md:divide-y md:divide-gray-200">
      <thead class="streams-thead hidden md:table-header-group bg-gray-50">
        <tr>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("streamer", @sort_column, @sort_direction) %>"
              data-column="streamer"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("streamer", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Streamer", "streamer", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("title", @sort_column, @sort_direction) %>"
              data-column="title"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("title", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Title", "title", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("source", @sort_column, @sort_direction) %>"
              data-column="source"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("source", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Source", "source", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("link", @sort_column, @sort_direction) %>"
              data-column="link"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("link", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Link", "link", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("platform", @sort_column, @sort_direction) %>"
              data-column="platform"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("platform", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Platform", "platform", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("status", @sort_column, @sort_direction) %>"
              data-column="status"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("status", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Status", "status", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("city", @sort_column, @sort_direction) %>"
              data-column="city"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("city", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("City", "city", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("state", @sort_column, @sort_direction) %>"
              data-column="state"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("state", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("State", "state", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("kind", @sort_column, @sort_direction) %>"
              data-column="kind"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("kind", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Kind", "kind", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("orientation", @sort_column, @sort_direction) %>"
              data-column="orientation"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("orientation", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Orientation", "orientation", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("started_at", @sort_column, @sort_direction) %>"
              data-column="started_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("started_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Started At", "started_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("last_checked_at", @sort_column, @sort_direction) %>"
              data-column="last_checked_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("last_checked_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Last Checked", "last_checked_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("last_live_at", @sort_column, @sort_direction) %>"
              data-column="last_live_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("last_live_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Last Live", "last_live_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              data-column="actions"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("actions", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="streams-tbody block md:table-row-group space-y-4 md:space-y-0">
        <%= render partial: "admin/streams/spreadsheet_row", collection: @streams, as: :stream %>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="mt-4">
    <%== @pagy.series_nav if @pagy.pages > 1 %>
  </div>
</div>
