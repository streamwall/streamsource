<div data-controller="collaborative-spreadsheet stream-table-preferences"
     data-collaborative-spreadsheet-current-user-id-value="<%= current_admin_user.id.to_s %>"
     data-collaborative-spreadsheet-current-user-name-value="<%= current_admin_user.display_name %>"
     data-collaborative-spreadsheet-current-user-color-value="<%= user_color(current_admin_user) %>"
     data-stream-table-preferences-hidden-columns-value="<%= @hidden_columns.to_json %>"
     data-stream-table-preferences-column-order-value="<%= @column_order.to_json %>"
     data-stream-table-preferences-preferences-url-value="<%= admin_stream_preferences_path %>"
     class="relative">
  
  <!-- Column Preferences + Active Users -->
  <div class="flex flex-wrap items-center justify-between gap-3 pb-3">
    <div class="flex flex-wrap items-center gap-2">
      <details class="relative">
        <summary class="cursor-pointer select-none px-3 py-1.5 text-sm bg-white border border-gray-200 rounded-md shadow-sm hover:bg-gray-50">
          Columns
        </summary>
        <div class="absolute left-0 mt-2 w-56 max-h-64 overflow-y-auto bg-white border border-gray-200 rounded-md shadow-lg z-20 p-3">
          <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Show columns</div>
          <div class="space-y-1">
            <% stream_table_columns.each do |column| %>
              <label class="flex items-center gap-2 text-sm text-gray-700">
                <%= check_box_tag "stream_columns[]",
                                  column[:key],
                                  !@hidden_columns.include?(column[:key]),
                                  class: "h-4 w-4 text-indigo-600 border-gray-300 rounded",
                                  data: { action: "stream-table-preferences#toggleColumn",
                                          stream_table_preferences_target: "columnToggle" } %>
                <span><%= column[:label] %></span>
              </label>
            <% end %>
          </div>
        </div>
      </details>
      <span class="text-xs text-gray-500">Sort by clicking headers. Drag headers to reorder.</span>
    </div>

    <!-- Active Users Presence -->
    <div class="flex items-center gap-2">
      <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Active Users</span>
      <span data-collaborative-spreadsheet-target="presenceCount"
            class="inline-flex items-center justify-center min-w-[1.25rem] h-5 px-1.5 text-[11px] font-medium text-gray-600 bg-gray-100 rounded-full">
        0
      </span>
      <div data-collaborative-spreadsheet-target="presenceList"
           class="flex items-center gap-1">
        <!-- Users will be dynamically added here -->
      </div>
    </div>
  </div>
  
  <!-- Spreadsheet Table -->
  <div class="overflow-x-auto bg-white rounded-lg shadow"
       data-stream-table-preferences-target="scrollContainer">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("streamer", @sort_column, @sort_direction) %>"
              data-column="streamer"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("streamer", "sticky left-0 z-10 bg-gray-50 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Streamer", "streamer", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("title", @sort_column, @sort_direction) %>"
              data-column="title"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("title", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Title", "title", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("source", @sort_column, @sort_direction) %>"
              data-column="source"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("source", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Source", "source", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("link", @sort_column, @sort_direction) %>"
              data-column="link"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("link", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Link", "link", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("platform", @sort_column, @sort_direction) %>"
              data-column="platform"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("platform", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Platform", "platform", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("status", @sort_column, @sort_direction) %>"
              data-column="status"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("status", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Status", "status", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("city", @sort_column, @sort_direction) %>"
              data-column="city"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("city", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("City", "city", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("state", @sort_column, @sort_direction) %>"
              data-column="state"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("state", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("State", "state", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("kind", @sort_column, @sort_direction) %>"
              data-column="kind"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("kind", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Kind", "kind", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("orientation", @sort_column, @sort_direction) %>"
              data-column="orientation"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("orientation", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Orientation", "orientation", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("started_at", @sort_column, @sort_direction) %>"
              data-column="started_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("started_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Started At", "started_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("last_checked_at", @sort_column, @sort_direction) %>"
              data-column="last_checked_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("last_checked_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Last Checked", "last_checked_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              aria-sort="<%= stream_sort_aria("last_live_at", @sort_column, @sort_direction) %>"
              data-column="last_live_at"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("last_live_at", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            <%= stream_sort_link("Last Live", "last_live_at", current_sort: @sort_column, current_direction: @sort_direction) %>
          </th>
          <th scope="col"
              data-column="actions"
              data-stream-table-preferences-target="column"
              class="<%= stream_column_class("actions", "px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider", @hidden_columns) %>">
            Actions
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        <%= render partial: "admin/streams/spreadsheet_row", collection: @streams, as: :stream %>
      </tbody>
    </table>
  </div>
  
  <!-- Pagination -->
  <div class="mt-4">
    <%== @pagy.series_nav if @pagy.pages > 1 %>
  </div>
</div>
