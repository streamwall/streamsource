#!/bin/bash

# Health check script for StreamSource
APP_URL="https://{{ app_domain | default('localhost') }}/health"
TIMEOUT=10
MAX_RETRIES=3

check_health() {
    local retry=0
    while [ $retry -lt $MAX_RETRIES ]; do
        response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout $TIMEOUT "$APP_URL")
        if [ "$response" -eq 200 ]; then
            echo "Health check passed"
            return 0
        fi
        retry=$((retry + 1))
        sleep 5
    done
    
    echo "Health check failed after $MAX_RETRIES attempts"
    return 1
}

# Run health check
if ! check_health; then
    # Attempt to restart services
    systemctl restart puma
    systemctl restart nginx
    
    # Send alert (configure your alerting method here)
    echo "StreamSource health check failed at $(date)" | logger -t streamsource-health
fi