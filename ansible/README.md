# StreamSource Ansible Configuration

This directory contains Ansible playbooks and roles for configuring StreamSource infrastructure.

## Architecture

The Ansible setup provides two deployment options:

1. **DigitalOcean App Platform** (default): Managed platform deployment
2. **Droplets with Ansible**: Traditional VPS deployment with full control

## Directory Structure

```
ansible/
├── ansible.cfg          # Ansible configuration
├── site.yml            # Main playbook
├── inventory/          # Inventory files
│   └── hosts.yml       # Generated by Terraform
├── roles/              # Ansible roles
│   ├── common/         # Basic server setup
│   ├── ruby/           # Ruby and rbenv installation
│   ├── nodejs/         # Node.js installation
│   ├── nginx/          # Nginx web server
│   ├── app/            # Application deployment
│   └── monitoring/     # Monitoring setup
└── README.md           # This file
```

## Roles

### common
- System updates and security hardening
- Firewall configuration (UFW)
- User creation and SSH setup
- Kernel parameter tuning

### ruby
- Installs rbenv and ruby-build
- Installs Ruby 3.3.6
- Configures bundler

### nodejs
- Installs Node.js 20.x
- Installs Yarn package manager

### nginx
- Installs and configures Nginx
- SSL setup (self-signed or Let's Encrypt)
- Proxy configuration for Puma
- Performance optimizations

### app
- Clones application repository
- Installs dependencies
- Compiles assets
- Configures Puma service
- Sets up log rotation

### monitoring
- Prometheus node exporter
- Health check scripts
- Collectd for metrics

## Usage

### Option 1: Automated via Terraform

When using Droplets, Terraform automatically runs Ansible:

```bash
cd terraform
terraform apply -var="use_droplets=true"
```

### Option 2: Manual Execution

1. Ensure inventory is configured:
   ```bash
   cp inventory/hosts.yml.example inventory/hosts.yml
   # Edit hosts.yml with your server details
   ```

2. Run the playbook:
   ```bash
   ansible-playbook site.yml
   ```

3. Run specific roles:
   ```bash
   ansible-playbook site.yml --tags monitoring
   ```

## Variables

Key variables that need to be set:

- `database_url`: PostgreSQL connection string
- `redis_url`: Redis connection string
- `secret_key_base`: Rails secret key
- `rails_master_key`: Rails master key
- `jwt_secret`: JWT authentication secret
- `github_repo`: Repository URL
- `app_domain`: Application domain

## SSH Keys

Ensure your SSH key is added to DigitalOcean:

```bash
doctl compute ssh-key create "ansible-key" --public-key-file ~/.ssh/id_rsa.pub
```

## Security Considerations

1. **Firewall**: UFW is configured to allow only SSH, HTTP, and HTTPS
2. **Fail2ban**: Protects against brute force attacks
3. **Automatic Updates**: Security updates are applied automatically
4. **SSL**: Nginx is configured with SSL (self-signed by default)

## Customization

### Adding Environment Variables

Edit `roles/app/templates/env.j2` to add custom environment variables.

### Changing Ruby/Node versions

Update the following variables:
- `ruby_version` in inventory
- `nodejs_version` in inventory

### Custom Nginx Configuration

Edit `roles/nginx/templates/streamsource.conf.j2` for custom Nginx settings.

## Troubleshooting

### Connection Issues
```bash
ansible all -m ping -i inventory/hosts.yml
```

### View Ansible Facts
```bash
ansible all -m setup -i inventory/hosts.yml
```

### Dry Run
```bash
ansible-playbook site.yml --check
```

### Verbose Output
```bash
ansible-playbook site.yml -vvv
```

## Maintenance

### Update Application
```bash
ansible-playbook site.yml --tags app
```

### Restart Services
```bash
ansible app_servers -m systemd -a "name=puma state=restarted" -b
ansible app_servers -m systemd -a "name=nginx state=restarted" -b
```

### View Logs
```bash
ansible app_servers -m command -a "journalctl -u puma -n 100" -b
```